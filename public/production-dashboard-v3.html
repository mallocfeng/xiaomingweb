<!doctype html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>生产订单KanBan V2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      /* Refined color palette - keeping original orange tones */
      --orange: #e8894a;
      --orange-muted: #d97c3f;
      --peach: #f5ebe3;
      --peach-tint: #f0e5db;
      --cream: #fdfbf9;
      --green: #68b35b;
      --green-bg: #eef7ec;
      --gray-50: #fafafa;
      --gray-100: #f7f8fc;
      --gray-200: #e8eaef;
      --gray-300: #d2d4db;
      --gray-400: #8a8d96;
      --gray-500: #6e7078;
      --gray-600: #2c2e33;
      --text-primary: #2c2e33;
      --text-secondary: #8a8d96;
      --text-tertiary: #6e7078;
      --separator: rgba(0, 0, 0, 0.05);
      --panel-gap: clamp(10px, 1.2vw, 18px);
      --panel-padding: clamp(14px, 1.8vw, 26px);
      --body-padding: clamp(14px, 1.2vw, 22px);
      --dash-max-height: calc(100vh - 2 * var(--body-padding));
      --panel-radius: 20px;
      --card-radius: 14px;
      /* Soft blue-gray tinted shadows */
      --shadow-sm: 0 2px 8px rgba(100, 110, 140, 0.08), 0 1px 3px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 16px rgba(100, 110, 140, 0.1), 0 2px 6px rgba(0, 0, 0, 0.05);
      --shadow-lg: 0 8px 32px rgba(100, 110, 140, 0.12), 0 4px 12px rgba(0, 0, 0, 0.06);
      --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    html {
      height: 100%;
      font-size: clamp(15px, 1.1vw + 0.4vh, 26px);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      background: linear-gradient(135deg, #d5dbe8 0%, #e0e5ef 50%, #d8dfec 100%);
      padding: var(--body-padding);
      color: var(--text-primary);
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", sans-serif;
      font-size: 1rem;
      line-height: 1.47059;
      letter-spacing: -0.022em;
      align-items: stretch;
      justify-content: stretch;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .dashboard {
      flex: 1;
      min-height: 0;
      width: 100%;
      max-width: none;
      max-height: calc(100vh - 2 * var(--body-padding));
      display: grid;
      grid-template-columns: minmax(250px, 320px) 1fr;
      gap: var(--panel-gap);
      /* No extra wrapper - panels sit directly on gradient background */
    }

    .left-panel,
    .main-panel {
      background: #fff;
      border-radius: var(--panel-radius);
      box-shadow: var(--shadow-md);
      padding: var(--panel-padding);
    }

    .left-panel {
      display: flex;
      flex-direction: column;
      gap: var(--panel-gap);
      min-height: 0;
    }

    .logo {
      background: linear-gradient(180deg, #d41920 0%, #c8151a 40%, #b01216 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      font-weight: 700;
      font-style: italic;
      letter-spacing: 0.5px;
      border-radius: 10px;
      padding: 0.8rem 1rem;
      flex-shrink: 0;
    }

    .panel-title {
      background: var(--orange);
      color: #fff;
      font-weight: 600;
      padding: 0.6rem 1rem;
      font-size: 0.85rem;
      border-radius: 10px 10px 0 0;
      margin: 0;
      letter-spacing: 0.02em;
    }

    .order-status {
      background: var(--peach);
      overflow: hidden;
      border-radius: 10px;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .order-status-list {
      flex: 1;
      overflow-y: auto;
    }

    .order-item {
      padding: 0.6rem 0.8rem;
      border-top: 1px solid var(--separator);
      display: grid;
      gap: 6px;
    }

    .order-item:first-of-type {
      border-top: none;
    }

    .order-label {
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-primary);
    }

    .progress {
      height: 8px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.06);
      overflow: hidden;
    }

    .progress span {
      display: block;
      height: 100%;
      background: #f5c518;
      width: 70%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .progress.blue span {
      background: #007aff;
      width: 85%;
    }

    .progress.gray span {
      background: var(--gray-400);
      width: 62%;
    }

    .equipment-status {
      background: var(--green-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      font-weight: 600;
      color: #1a7f37;
      border-radius: 10px;
      padding: 1.2rem;
      min-height: 120px;
      flex-shrink: 0;
    }

    .main-panel {
      display: grid;
      grid-template-rows: auto minmax(0, 1fr) minmax(0, clamp(100px, 13vh, 170px));
      gap: clamp(8px, 1vw, 14px);
      min-height: 0;
      overflow: hidden;
    }

    .top-bar {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: var(--panel-gap);
    }

    .info-card {
      background: var(--peach);
      padding: 0.85rem 1rem;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      min-height: 56px;
      gap: 0.5rem;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-sm);
      transition: background var(--transition), box-shadow var(--transition), transform var(--transition);
    }

    .info-card:hover {
      background: var(--peach-tint);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .info-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      white-space: nowrap;
      font-weight: 500;
    }

    .info-value {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      white-space: nowrap;
      letter-spacing: -0.02em;
    }

    .table-wrap {
      background: var(--peach);
      width: 100%;
      display: flex;
      flex-direction: column;
      padding: 0;
      flex: 1;
      min-height: 0;
      overflow: hidden;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-sm);
    }

    table {
      width: 100%;
      height: 100%;
      border-collapse: collapse;
      text-align: center;
      table-layout: fixed;
      display: flex;
      flex-direction: column;
    }

    thead {
      flex-shrink: 0;
    }

    tbody {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    thead tr,
    tbody tr {
      display: flex;
      width: 100%;
    }

    thead th,
    tbody td {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.35em 0.5em;
      line-height: 1.15;
      min-width: 0;
    }

    thead th {
      font-size: clamp(11px, 0.85rem, 15px);
      word-break: keep-all;
      word-wrap: break-word;
      overflow-wrap: break-word;
      text-align: center;
      flex-wrap: wrap;
    }

    tbody td {
      word-break: break-word;
    }

    tbody tr {
      flex: 1;
      min-height: 0;
    }

    tbody td {
      font-size: clamp(11px, 0.8rem, 14px);
    }

    tbody tr:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .cell-stack {
      display: flex;
      flex-direction: column;
      gap: 2px;
      line-height: 1.2;
    }

    .cell-stack small {
      font-size: 0.7em;
      color: var(--text-secondary);
    }

    thead th {
      background: var(--orange);
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    thead th:first-child {
      border-radius: var(--card-radius) 0 0 0;
    }

    thead th:last-child {
      border-radius: 0 var(--card-radius) 0 0;
    }

    tbody td {
      border-bottom: 1px solid var(--separator);
      background: transparent;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:last-child td:first-child {
      border-radius: 0 0 0 var(--card-radius);
    }

    tbody tr:last-child td:last-child {
      border-radius: 0 0 var(--card-radius) 0;
    }

    tbody td:first-child {
      font-weight: 600;
      color: var(--text-primary);
      background: rgba(0, 0, 0, 0.02);
    }

    .highlight {
      color: #d4380d;
      font-weight: 600;
    }

    .charts {
      display: grid;
      grid-template-columns: 1.3fr 1fr 220px;
      gap: 12px;
      align-items: stretch;
      min-height: 0;
      height: 100%;
    }

    .chart-card {
      background: var(--gray-100);
      padding: 12px;
      height: 100%;
      overflow: hidden;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-sm);
      transition: box-shadow var(--transition);
    }

    .chart-card:hover {
      box-shadow: var(--shadow-md);
    }

    .legend {
      background: var(--gray-100);
      font-size: 12px;
      padding: 0.75rem;
      line-height: 1.5;
      height: 100%;
      overflow: hidden;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-sm);
    }

    .legend div {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.3rem;
      border-bottom: 1px solid var(--separator);
      padding: 4px 0;
    }

    .legend div:last-child {
      border-bottom: none;
    }

    .chart-card--pie {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem;
      min-height: 0;
    }

    .pie-tilt {
      position: relative;
      width: min(400px, 98%);
      max-height: none;
      aspect-ratio: 1 / 0.88;
      height: 90%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: rotateX(20deg) scaleY(0.96);
      transform-origin: center;
      filter: drop-shadow(0 8px 0 rgba(0, 0, 0, 0.05));
    }

    .pie-tilt::after {
      content: "";
      position: absolute;
      width: 72%;
      height: 15%;
      bottom: -6%;
      left: 14%;
      background: radial-gradient(circle, rgba(0, 0, 0, 0.08), transparent 70%);
      transform: rotateX(90deg);
    }

    #pieChart {
      width: 100%;
      height: 100%;
    }

    #barChart {
      height: 100% !important;
      width: 100% !important;
    }

    @media (max-width: 1100px) {
      .dashboard {
        grid-template-columns: 1fr;
      }

      .left-panel {
        grid-template-rows: auto auto auto;
      }

      .top-bar {
        grid-template-columns: 1fr;
      }

      .charts {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        height: auto;
      }
    }

    @media (max-height: 900px) {
      .main-panel {
        gap: 6px;
      }

      .info-card {
        min-height: 46px;
        padding: 0.65rem 0.8rem;
      }

      .table-wrap {
        padding: 0.25rem;
        --thead-base: 36px;
        --row-base: 26px;
        --cell-font-base: 13px;
        --thead-font-base: 14px;
        --cell-pad-y-base: 5px;
        --cell-pad-x-base: 5px;
      }

      .cell-stack {
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
        white-space: nowrap;
      }

      .cell-stack small {
        font-size: 0.68em;
      }

      tbody td {
        line-height: 1.05;
      }

      .charts {
        min-height: 100px;
        height: 130px;
        gap: 6px;
      }
    }

    @media (max-height: 760px) {
      html {
        font-size: 14px;
      }

      .info-card {
        min-height: 40px;
        padding: 0.5rem 0.6rem;
      }

      .charts {
        min-height: 70px;
        height: 90px;
        gap: 4px;
      }

      .legend {
        font-size: 0.8rem;
        line-height: 1.3;
      }

      .table-wrap {
        --thead-base: 32px;
        --row-base: 22px;
        --cell-font-base: 12px;
        --thead-font-base: 13px;
        --cell-pad-y-base: 4px;
        --cell-pad-x-base: 4px;
      }

      .cell-stack {
        gap: 0.25rem;
      }

      .cell-stack small {
        font-size: 0.65em;
      }

      tbody td {
        line-height: 1.02;
      }

      .chart-card {
        padding: 2px;
      }

      .pie-tilt {
        max-width: 220px;
        height: 80%;
      }
    }

    @media (max-width: 640px) {
      body {
        padding: 8px;
      }

      .dashboard {
        padding: 10px;
        border-width: 1px;
      }

      .panel-title {
        font-size: 1rem;
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce) {

      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Data refresh scan line animation */
    @keyframes scanLine {
      0% {
        top: -10%;
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        top: 110%;
        opacity: 0;
      }
    }

    .equipment-status {
      position: relative;
      overflow: hidden;
    }

    .equipment-status::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg,
          transparent 0%,
          rgba(26, 127, 55, 0.3) 20%,
          rgba(26, 127, 55, 0.8) 50%,
          rgba(26, 127, 55, 0.3) 80%,
          transparent 100%);
      box-shadow: 0 0 10px rgba(26, 127, 55, 0.5), 0 0 20px rgba(26, 127, 55, 0.3);
      top: -10%;
      opacity: 0;
      pointer-events: none;
    }

    .equipment-status.scanning::after {
      animation: scanLine 1.2s ease-in-out;
    }

    /* Subtle pulse on data cards during refresh */
    .refreshing {
      animation: pulse 0.6s ease-in-out;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }
  </style>
</head>

<body>
  <div class="dashboard">
    <aside class="left-panel">
      <div class="logo" data-logo>Danfoss</div>
      <div class="order-status">
        <div class="panel-title">订单状态</div>
        <div class="order-status-list" data-order-status></div>
      </div>
      <div class="equipment-status" data-equipment-status>设备状态</div>
    </aside>

    <section class="main-panel">
      <div class="top-bar" data-top-bar></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr data-table-head></tr>
          </thead>
          <tbody data-table-body></tbody>
        </table>
      </div>

      <div class="charts">
        <div class="chart-card">
          <canvas id="barChart"></canvas>
        </div>
        <div class="chart-card chart-card--pie">
          <div class="pie-tilt">
            <canvas id="pieChart"></canvas>
          </div>
        </div>
        <div class="legend" data-legend></div>
      </div>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module">
    import { initTableSizing } from './production-dashboard-table.mjs';

    const tableSizer = initTableSizing(document.querySelector('.table-wrap'));
    const ChartJS = window.Chart;

    const barCtx = document.getElementById('barChart');
    const barChart = new ChartJS(barCtx, {
      type: 'bar',
      data: {
        labels: [],
        datasets: [{ label: '产出', data: [], backgroundColor: '#007aff', borderRadius: 4 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.06)' },
            ticks: { color: '#86868b', font: { size: 10, family: 'Inter, -apple-system, sans-serif' } }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#86868b', font: { size: 10, family: 'Inter, -apple-system, sans-serif' } }
          }
        }
      }
    });

    const pieCtx = document.getElementById('pieChart');
    const pieChart = new ChartJS(pieCtx, {
      type: 'pie',
      data: {
        labels: [],
        datasets: [{ data: [], backgroundColor: ['#34c759', '#f5c518', '#e8894a'], borderWidth: 0 }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 11, family: 'Inter, -apple-system, sans-serif' }, padding: 12 } }
        }
      }
    });

    const dataUrl = './production-dashboard-data.json';
    const refreshInterval = 10000;

    const buildInfoCard = (label, value) => {
      const card = document.createElement('div');
      card.className = 'info-card';
      card.innerHTML = `<span class="info-label">${label}</span><span class="info-value">${value}</span>`;
      return card;
    };

    const buildOrderItem = (item) => {
      const wrap = document.createElement('div');
      wrap.className = 'order-item';
      const progressClass = item.variant ? `progress ${item.variant}` : 'progress';
      wrap.innerHTML = `
        <div class="order-label">${item.label}</div>
        <div class="${progressClass}"><span style="width:${item.progress}%"></span></div>
      `;
      return wrap;
    };

    const buildCell = (value) => {
      if (value && typeof value === 'object') {
        const lines = Array.isArray(value.lines) ? value.lines : [];
        const extra = value.extra ? `<small>${value.extra}</small>` : '';
        const lineHtml = lines.map((line) => `<span>${line}</span>`).join('');
        return `<div class="cell-stack">${lineHtml}${extra}</div>`;
      }
      return value ?? '';
    };

    const updateTable = (table) => {
      const headRow = document.querySelector('[data-table-head]');
      const body = document.querySelector('[data-table-body]');
      if (!headRow || !body) return;

      // Format column header for better line breaks
      const formatColumnHeader = (text) => {
        return text
          .replace(/\s*-\s*/g, '<br>') // Line break after dash
          .replace(/（/g, '<br>（')    // Line break before Chinese parenthesis
          .replace(/\(/g, '<br>(');    // Line break before English parenthesis
      };

      headRow.innerHTML = '';
      table.columns.forEach((column) => {
        const th = document.createElement('th');
        th.innerHTML = formatColumnHeader(column);
        headRow.appendChild(th);
      });

      body.innerHTML = '';
      table.rows.forEach((row) => {
        const tr = document.createElement('tr');
        row.forEach((cell, index) => {
          const td = document.createElement('td');
          if (index === 4) {
            td.classList.add('highlight');
          }
          td.innerHTML = buildCell(cell);
          tr.appendChild(td);
        });
        body.appendChild(tr);
      });
    };

    const updateLegend = (items) => {
      const legend = document.querySelector('[data-legend]');
      if (!legend) return;
      legend.innerHTML = '';
      items.forEach((item) => {
        const row = document.createElement('div');
        row.innerHTML = `<span>${item.left}</span><span>${item.right}</span>`;
        legend.appendChild(row);
      });
    };

    const applyData = (data) => {
      if (!data) return;

      const topBar = document.querySelector('[data-top-bar]');
      if (topBar) {
        topBar.innerHTML = '';
        data.topInfo.forEach((info) => {
          topBar.appendChild(buildInfoCard(info.label, info.value));
        });
      }

      const orderStatus = document.querySelector('[data-order-status]');
      if (orderStatus) {
        orderStatus.innerHTML = '';
        data.orderStatus.forEach((item) => orderStatus.appendChild(buildOrderItem(item)));
      }

      const equipment = document.querySelector('[data-equipment-status]');
      if (equipment) {
        equipment.textContent = data.equipmentStatus;
      }

      updateTable(data.table);

      if (data.barChart) {
        barChart.data.labels = data.barChart.labels;
        barChart.data.datasets[0].data = data.barChart.values;
        barChart.update();
      }

      if (data.pieChart) {
        pieChart.data.labels = data.pieChart.labels;
        pieChart.data.datasets[0].data = data.pieChart.values;
        pieChart.update();
      }

      updateLegend(data.legend);

      tableSizer.update();
    };

    const loadData = async () => {
      // Trigger scan animation
      const equipment = document.querySelector('[data-equipment-status]');
      if (equipment) {
        equipment.classList.add('scanning');
        setTimeout(() => equipment.classList.remove('scanning'), 1200);
      }

      try {
        const response = await fetch(`${dataUrl}?t=${Date.now()}`, { cache: 'no-store' });
        if (!response.ok) return;
        const payload = await response.json();
        applyData(payload);
      } catch (error) {
        console.warn('Failed to load dashboard data', error);
      }
    };

    loadData();
    setInterval(loadData, refreshInterval);
  </script>
</body>

</html>